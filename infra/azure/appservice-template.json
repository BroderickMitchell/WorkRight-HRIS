{
  "$schema": "http://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "subscriptionId": {
      "type": "String",
      "metadata": {
        "description": "Subscription that hosts the resources. Used for cross-resource references."
      }
    },
    "resourceGroupName": {
      "type": "String",
      "metadata": {
        "description": "Resource group that contains the deployment."
      }
    },
    "name": {
      "type": "String",
      "metadata": {
        "description": "Name of the Web App."
      }
    },
    "location": {
      "type": "String",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "hostingPlanName": {
      "type": "String",
      "metadata": {
        "description": "App Service plan name."
      }
    },
    "serverFarmResourceGroup": {
      "type": "String",
      "metadata": {
        "description": "Resource group that contains the App Service plan."
      }
    },
    "alwaysOn": {
      "type": "Bool",
      "defaultValue": true
    },
    "ftpsState": {
      "type": "String",
      "defaultValue": "FtpsOnly"
    },
    "autoGeneratedDomainNameLabelScope": {
      "type": "String",
      "defaultValue": "TenantReuse"
    },
    "sku": {
      "type": "String"
    },
    "skuCode": {
      "type": "String"
    },
    "workerSize": {
      "type": "String"
    },
    "workerSizeId": {
      "type": "String"
    },
    "numberOfWorkers": {
      "type": "String"
    },
    "linuxFxVersion": {
      "type": "String"
    },
    "siteContainerName": {
      "type": "String"
    },
    "vnetName": {
      "type": "String"
    },
    "vnetAddressPrefix": {
      "type": "String"
    },
    "appSubnetName": {
      "type": "String"
    },
    "appSubnetAddressPrefix": {
      "type": "String"
    },
    "outboundSubnetName": {
      "type": "String"
    },
    "outboundSubnetAddressPrefix": {
      "type": "String"
    },
    "siteConfigName": {
      "type": "String",
      "defaultValue": "[format('sc-{0}', uniqueString(parameters('name')))]"
    },
    "postgreSqlServerName": {
      "type": "String"
    },
    "postgreSqlServerAdminUsername": {
      "type": "String"
    },
    "postgreSqlServerAdminPwd": {
      "type": "SecureString"
    },
    "postgresqlDatabaseSku": {
      "type": "String"
    },
    "postgresqlDatabaseTier": {
      "type": "String"
    },
    "postgreSqlServerTags": {
      "type": "Object",
      "defaultValue": {}
    },
    "postgreSqlDatabaseName": {
      "type": "String"
    },
    "postgreSqlDatabaseTags": {
      "type": "Object",
      "defaultValue": {}
    },
    "privateDnsZoneName": {
      "type": "String"
    },
    "virtualLinkName": {
      "type": "String"
    },
    "cacheName": {
      "type": "String"
    },
    "cacheTags": {
      "type": "Object",
      "defaultValue": {}
    },
    "cacheSkuName": {
      "type": "String",
      "defaultValue": "Standard"
    },
    "cacheSkuFamily": {
      "type": "String",
      "defaultValue": "C"
    },
    "cacheSkuCapacity": {
      "type": "String",
      "defaultValue": "1"
    },
    "redisPrivateDnsZoneName": {
      "type": "String"
    },
    "redisVirtualLinkName": {
      "type": "String"
    },
    "redisPrivateEndpointName": {
      "type": "String"
    },
    "redisDnsZoneGroupName": {
      "type": "String",
      "defaultValue": "default"
    },
    "redisCacheServiceConnectorName": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2018-11-01",
      "name": "[parameters('hostingPlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "Tier": "[parameters('sku')]",
        "Name": "[parameters('skuCode')]"
      },
      "kind": "linux",
      "properties": {
        "name": "[parameters('hostingPlanName')]",
        "workerSize": "[parameters('workerSize')]",
        "workerSizeId": "[parameters('workerSizeId')]",
        "numberOfWorkers": "[parameters('numberOfWorkers')]",
        "reserved": true,
        "zoneRedundant": false
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2020-07-01",
      "name": "[parameters('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('vnetAddressPrefix')]"
          ]
        }
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2020-07-01",
      "name": "[format('{0}/{1}', parameters('vnetName'), parameters('appSubnetName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
      ],
      "properties": {
        "addressPrefix": "[parameters('appSubnetAddressPrefix')]",
        "delegations": [
          {
            "name": "delegation",
            "properties": {
              "serviceName": "Microsoft.Web/serverfarms"
            }
          }
        ],
        "serviceEndpoints": []
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2020-07-01",
      "name": "[format('{0}/{1}', parameters('vnetName'), parameters('outboundSubnetName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
      ],
      "properties": {
        "addressPrefix": "[parameters('outboundSubnetAddressPrefix')]",
        "delegations": [
          {
            "name": "dlg-database",
            "properties": {
              "serviceName": "Microsoft.DBforPostgreSQL/flexibleServers"
            }
          }
        ],
        "serviceEndpoints": []
      }
    },
    {
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2018-09-01",
      "name": "[parameters('privateDnsZoneName')]",
      "location": "global",
      "properties": {},
      "resources": [
        {
          "type": "virtualNetworkLinks",
          "apiVersion": "2018-09-01",
          "name": "[parameters('virtualLinkName')]",
          "location": "global",
          "dependsOn": [
            "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]",
            "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
          ],
          "properties": {
            "virtualNetwork": {
              "id": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "registrationEnabled": false
          }
        }
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2022-12-01",
      "name": "[parameters('postgreSqlServerName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('outboundSubnetName'))]",
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
      ],
      "tags": "[parameters('postgreSqlServerTags')]",
      "sku": {
        "name": "[parameters('postgresqlDatabaseSku')]",
        "tier": "[parameters('postgresqlDatabaseTier')]"
      },
      "properties": {
        "administratorLogin": "[parameters('postgreSqlServerAdminUsername')]",
        "administratorLoginPassword": "[parameters('postgreSqlServerAdminPwd')]",
        "version": "14",
        "publicNetworkAccess": "Disabled",
        "haEnabled": "Disabled",
        "storageProfile": {
          "storageMB": 131072,
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Disabled"
        },
        "delegatedSubnetArguments": {
          "subnetArmResourceId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('outboundSubnetName'))]"
        },
        "privateDnsZoneArguments": {
          "privateDnsZoneArmResourceId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
        }
      },
      "resources": [
        {
          "type": "databases",
          "apiVersion": "2022-12-01",
          "name": "[parameters('postgreSqlDatabaseName')]",
          "dependsOn": [
            "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgreSqlServerName'))]"
          ],
          "tags": "[parameters('postgreSqlDatabaseTags')]",
          "properties": {
            "charset": "utf8",
            "collation": "en_US.utf8"
          }
        }
      ]
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2022-03-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlanName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('appSubnetName'))]"
      ],
      "properties": {
        "serverFarmId": "[concat('/subscriptions/', parameters('subscriptionId'), '/resourceGroups/', parameters('serverFarmResourceGroup'), '/providers/Microsoft.Web/serverfarms/', parameters('hostingPlanName'))]",
        "httpsOnly": true,
        "publicNetworkAccess": "Enabled",
        "clientAffinityEnabled": false,
        "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('appSubnetName'))]",
        "vnetRouteAllEnabled": true,
        "autoGeneratedDomainNameLabelScope": "[parameters('autoGeneratedDomainNameLabelScope')]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
              "value": "false"
            }
          ],
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "alwaysOn": "[parameters('alwaysOn')]",
          "ftpsState": "[parameters('ftpsState')]"
        }
      },
      "resources": [
        {
          "type": "basicPublishingCredentialsPolicies",
          "apiVersion": "2022-09-01",
          "name": "[concat(parameters('name'), '/scm')]",
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', parameters('name'))]"
          ],
          "properties": {
            "allow": false
          }
        },
        {
          "type": "basicPublishingCredentialsPolicies",
          "apiVersion": "2022-09-01",
          "name": "[concat(parameters('name'), '/ftp')]",
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', parameters('name'))]"
          ],
          "properties": {
            "allow": false
          }
        }
      ]
    },
    {
      "type": "Microsoft.Web/sites/sitecontainers",
      "apiVersion": "2021-02-01",
      "name": "[format('{0}/{1}', parameters('name'), parameters('siteContainerName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('name'))]"
      ],
      "properties": {
        "image": "mcr.microsoft.com/appsvc/staticsite:latest",
        "targetPort": "80",
        "isMain": true,
        "startUpCommand": "",
        "authType": "Anonymous",
        "userManagedIdentityClientId": null,
        "userName": null,
        "passwordSecret": null
      }
    },
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2018-11-01",
      "name": "[format('{0}/{1}', parameters('name'), parameters('siteConfigName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', parameters('postgreSqlServerName'), parameters('postgreSqlDatabaseName'))]",
        "[resourceId('Microsoft.Web/sites', parameters('name'))]"
      ],
      "properties": {
        "AZURE_POSTGRESQL_CONNECTIONSTRING": {
          "value": "[concat('Database=', parameters('postgreSqlDatabaseName'), ';Server=', parameters('postgreSqlServerName'), '.postgres.database.azure.com;User Id=', parameters('postgreSqlServerAdminUsername'), ';Password=', parameters('postgreSqlServerAdminPwd'))]",
          "type": "Custom"
        }
      }
    },
    {
      "type": "Microsoft.Cache/Redis",
      "apiVersion": "2022-06-01",
      "name": "[parameters('cacheName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('cacheTags')]",
      "properties": {
        "sku": {
          "name": "[parameters('cacheSkuName')]",
          "family": "[parameters('cacheSkuFamily')]",
          "capacity": "[parameters('cacheSkuCapacity')]"
        },
        "redisConfiguration": {},
        "enableNonSslPort": false,
        "redisVersion": "6",
        "publicNetworkAccess": "Disabled"
      }
    },
    {
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2018-09-01",
      "name": "[parameters('redisPrivateDnsZoneName')]",
      "location": "global",
      "properties": {},
      "resources": [
        {
          "type": "virtualNetworkLinks",
          "apiVersion": "2018-09-01",
          "name": "[parameters('redisVirtualLinkName')]",
          "location": "global",
          "dependsOn": [
            "[resourceId('Microsoft.Network/privateDnsZones', parameters('redisPrivateDnsZoneName'))]",
            "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
          ],
          "properties": {
            "virtualNetwork": {
              "id": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "registrationEnabled": false
          }
        }
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2021-02-01",
      "name": "[parameters('redisPrivateEndpointName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Cache/Redis', parameters('cacheName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('outboundSubnetName'))]"
      ],
      "properties": {
        "subnet": {
          "id": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('outboundSubnetName'))]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[parameters('redisPrivateEndpointName')]",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.Cache/Redis', parameters('cacheName'))]",
              "groupIds": [
                "redisCache"
              ]
            }
          }
        ]
      },
      "resources": [
        {
          "type": "privateDnsZoneGroups",
          "apiVersion": "2021-02-01",
          "name": "[parameters('redisDnsZoneGroupName')]",
          "dependsOn": [
            "[resourceId('Microsoft.Network/privateEndpoints', parameters('redisPrivateEndpointName'))]",
            "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/privateDnsZones', parameters('redisPrivateDnsZoneName'))]"
          ],
          "properties": {
            "privateDnsZoneConfigs": [
              {
                "name": "[parameters('redisPrivateDnsZoneName')]",
                "properties": {
                  "privateDnsZoneId": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/privateDnsZones', parameters('redisPrivateDnsZoneName'))]"
                }
              }
            ]
          }
        }
      ]
    },
    {
      "type": "Microsoft.ServiceLinker/linkers",
      "apiVersion": "2022-05-01",
      "name": "[parameters('redisCacheServiceConnectorName')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('redisPrivateEndpointName'), parameters('redisDnsZoneGroupName'))]",
        "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Web/sites', parameters('name'))]",
        "[resourceId('Microsoft.Cache/Redis', parameters('cacheName'))]"
      ],
      "properties": {
        "targetService": {
          "type": "AzureResource",
          "id": "[resourceId('Microsoft.Cache/Redis/databases', parameters('cacheName'), '0')]"
        },
        "authInfo": {
          "authType": "secret"
        },
        "clientType": "none",
        "vNetSolution": {
          "type": "privateLink"
        }
      },
      "scope": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Web/sites', parameters('name'))]"
    }
  ]
}
