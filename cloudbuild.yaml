steps:
  # Build the container images
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '--tag=gcr.io/$PROJECT_ID/workright-hris-api',
        '--target=runtime-api',
        '.',
      ]

  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '--tag=gcr.io/$PROJECT_ID/workright-hris-web',
        '--target=runtime-web',
        '.',
      ]

  # Push the container images to Artifact/Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/workright-hris-api']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/workright-hris-web']

  # Deploy to Cloud Run (API)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - run
      - deploy
      - workright-api-$_ENVIRONMENT
      - --image=gcr.io/$PROJECT_ID/workright-hris-api
      - --region=$_REGION
      - --platform=managed
      - --allow-unauthenticated
      - --service-account=workright-run-$_ENVIRONMENT@$PROJECT_ID.iam.gserviceaccount.com
      - --set-env-vars=NODE_ENV=production,PORT=8080,DEMO_MODE=false,DEFAULT_LOCALE=en-AU,AUTH_AUDIENCE=workright-hris-production,AUTH_ISSUER=https://api.workright-hris.run.app/,STORAGE_BUCKET=workright-hris-storage-$_ENVIRONMENT
      - --set-secrets=DATABASE_URL=database-url:latest,REDIS_URL=redis-url:latest,AUTH_SECRET=auth-secret:latest
      - --vpc-connector=projects/$PROJECT_ID/locations/$_REGION/connectors/workright-connector-$_ENVIRONMENT
      - --vpc-egress=all-traffic
      - --quiet

  # Deploy to Cloud Run (Web)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - run
      - deploy
      - workright-web-$_ENVIRONMENT
      - --image=gcr.io/$PROJECT_ID/workright-hris-web
      - --region=$_REGION
      - --platform=managed
      - --allow-unauthenticated
      - --service-account=workright-run-$_ENVIRONMENT@$PROJECT_ID.iam.gserviceaccount.com
      - --set-secrets=NEXT_PUBLIC_API_URL=api-url:latest
      - --quiet

options:
  substitutionOption: ALLOW_LOOSE

substitutions:
  _REGION: us-central1
  _ENVIRONMENT: production

images:
  - 'gcr.io/$PROJECT_ID/workright-hris-api'
  - 'gcr.io/$PROJECT_ID/workright-hris-web'
